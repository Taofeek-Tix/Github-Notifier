name: Send Discord Performance Review Reminder

on:
  schedule:
    # 10 AM and 3 PM UTC (which is 11 AM and 4 PM WAT) every day in August
    - cron: '0 9 * * *'   # 9:00 AM UTC
    - cron: '0 15 * * *'  # 3:00 PM UTC
  workflow_dispatch:

jobs:
  send_discord_message:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord message
        run: |
          set -e

          TODAY=$(date -u +%Y-%m-%d)
          echo "Today's date: $TODAY"
          CUTOFF="2025-08-09"

          if [[ "$TODAY" > "$CUTOFF" ]]; then
            echo "Date is past August 8, 2025. Skipping message."
            exit 0
          fi

          MESSAGE=$(cat <<'EOF'
          Good Day @everyone

          As announced last week, our semi-annual performance review cycle is now live.

          Hereâ€™s what you need to do:
          Complete your self-review â†’ [LINK](https://forms.gle/Pe9Mmc6gxWZPr2Hb8)
          Managers, complete your reviews â†’  [LINK](https://forms.gle/zV1A5QSESHdfuWp3A)

          Please see below for key deadlines:

          ðŸ—“ï¸ Self-reviews due: Friday, August 8, 2025 11:59 PM
          ðŸ‘¥ Manager-employee review discussions to be completed by: Thursday, August 14, 2025 11:59 PM
          ðŸ“£ Promotions & raise announcements: August ALL HANDS

          The form will automatically lock on the date and time above. 

          Remember, this is an opportunity to reflect on your growth, give and receive feedback, and plan for whatâ€™s next.
          EOF
          )

          JSON=$(jq -n --arg content "$MESSAGE" '{content: $content}')
          echo "Payload:"
          echo "$JSON"

          RESPONSE=$(curl -s -w "%{http_code}" -o response.txt -H "Content-Type: application/json" \
            -X POST -d "$JSON" "$DISCORD_WEBHOOK_URL")

          echo "HTTP response: $RESPONSE"
          cat response.txt

          if [ "$RESPONSE" -ne 204 ]; then
            echo "Discord webhook failed"
            exit 1
          else
            echo "Message posted successfully"
          fi
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}